name: Generate Planning Video (Step 1 - Run & Collect)

on:
  workflow_dispatch:
    inputs:
      layer:
        description: "Layer(s) to run: empty=all, or e.g. ml2 or 'silver,ml2'"
        required: false
        default: ""
      step:
        description: "Step(s) to run: empty=all, or e.g. 'kpis_*' (names only, runner matches Step.name)"
        required: false
        default: ""
      start_from:
        description: "Start from layer (inclusive). e.g. silver/features/ml2. Empty=default behavior."
        required: false
        default: ""
      force:
        description: "Force re-run (true/false)"
        required: false
        default: "false"
      use_sample_data:
        description: "Use baseline cache strategy (true/false). true => restore baseline cache and default start_from=silver"
        required: false
        default: "true"
      baseline_key:
        description: "Baseline cache key suffix to restore (must match Build Baseline Cache workflow)."
        required: false
        default: "v1"

  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/generate_video.yml"
      - "src/**"
      - "requirements*.txt"

permissions:
  contents: read

concurrency:
  group: generate-video-step1-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  CI_ARTIFACTS_DIR: "ci_artifacts"
  CI_RUN_LOGS_DIR: "src/run_logs"
  CI_DATA_DIR: "data"
  OPS_CI: "1"

jobs:
  run-and-collect:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Check local Python
        shell: powershell
        run: |
          python --version
          where python

      - name: Check ffmpeg (optional for Step 1)
        shell: powershell
        continue-on-error: true
        run: |
          ffmpeg -version

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\pip\Cache
          key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt', 'requirements-ci.txt', 'pyproject.toml', 'poetry.lock') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install dependencies (user site-packages)
        shell: powershell
        run: |
          python -c "import sys; print('PY EXE =', sys.executable)"
          python -m pip --version
          python -m pip install --user -r requirements-ci.txt
          python -c "import yaml; print('PyYAML OK', yaml.__version__)"

      - name: Add user Python Scripts to PATH
        shell: powershell
        run: |
          $userScripts = Join-Path $env:APPDATA "Python\Python312\Scripts"
          Write-Host "UserScripts=$userScripts"
          echo $userScripts | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify imports
        shell: powershell
        run: |
          python -c "import yaml, pandas, pyarrow; print('Imports OK')"

      - name: Prepare data + artifacts folders
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:CI_DATA_DIR | Out-Null
          New-Item -ItemType Directory -Force -Path $env:CI_ARTIFACTS_DIR | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $env:CI_ARTIFACTS_DIR "snapshot") | Out-Null

      # ✅ BASELINE CACHE RESTORE (cross-run)
      - name: (Optional) Restore baseline cache (bronze/silver)
        if: ${{ inputs.use_sample_data == 'true' }}
        uses: actions/cache@v4
        with:
          path: |
            data/bronze
            data/silver
          key: baseline-data-${{ runner.os }}-${{ inputs.baseline_key }}

      # ✅ Guardrail: fail fast if baseline is missing/empty
      - name: (Optional) Validate baseline presence
        if: ${{ inputs.use_sample_data == 'true' }}
        shell: powershell
        run: |
          if (!(Test-Path "data/bronze")) { throw "Baseline cache not present: data/bronze missing. Run 'Build Baseline Data Cache' first or change baseline_key." }
          $b = Get-ChildItem -Recurse data/bronze -ErrorAction SilentlyContinue
          if ($b.Count -eq 0) { throw "Baseline cache not present: data/bronze empty. Run baseline workflow or change baseline_key." }
          Write-Host "Baseline restored OK. bronze files:" $b.Count
          if (Test-Path "data/silver") {
            $s = Get-ChildItem -Recurse data/silver -ErrorAction SilentlyContinue
            Write-Host "Silver files:" $s.Count
          } else {
            Write-Host "data/silver not present (OK if pipeline can rebuild silver from bronze)."
          }

      # (Optional) Ensure folder structure exists (does NOT overwrite baseline)
      - name: (Optional) Ensure folder structure
        if: ${{ inputs.use_sample_data == 'true' }}
        shell: powershell
        run: |
          $dirs = @(
            "data/bronze","data/silver","data/preds","data/features",
            "data/models/ml2","data/gold","data/eval/ml2","data/audit"
          )
          foreach ($d in $dirs) { New-Item -ItemType Directory -Force -Path $d | Out-Null }
          New-Item -ItemType File -Force -Path "data/.keep" | Out-Null

      - name: Build config/settings.yaml from template + secrets (sanitize)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "config" | Out-Null

          if (-not (Test-Path "config/settings.template.yaml")) {
            throw "Missing config/settings.template.yaml"
          }

          # Read template as raw text
          $content = Get-Content "config/settings.template.yaml" -Raw

          # Replace placeholders
          $content = $content.Replace("__SQL_USER__", "${{ secrets.SQL_USER }}")
          $content = $content.Replace("__SQL_PASSWORD__", "${{ secrets.SQL_PASSWORD }}")

          # Sanitize: remove non-printable control chars except TAB(0x09), LF(0x0A), CR(0x0D)
          $content = ($content.ToCharArray() | Where-Object {
            $c = [int][char]$_
            ($c -eq 9) -or ($c -eq 10) -or ($c -eq 13) -or ($c -ge 32)
          }) -join ''

          # Write as UTF-8 without BOM (more stable for parsers)
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText((Join-Path (Get-Location) "config/settings.yaml"), $content, $utf8NoBom)

          if (-not (Test-Path "config/settings.yaml")) { throw "settings.yaml was not created" }
          Write-Host "OK: config/settings.yaml created (sanitized)"

      - name: Preflight - verify config exists
        shell: powershell
        run: |
          Write-Host "PWD=$((Get-Location).Path)"
          if (Test-Path "config/settings.yaml") {
            Write-Host "OK: config/settings.yaml exists"
          } else {
            Write-Error "Missing config/settings.yaml"
            exit 1
          }

      - name: Validate settings.yaml has no control chars
        shell: powershell
        run: |
          $bytes = [System.IO.File]::ReadAllBytes("config/settings.yaml")
          foreach ($b in $bytes) {
            if (($b -lt 32) -and ($b -ne 9) -and ($b -ne 10) -and ($b -ne 13)) {
              throw ("Found control byte 0x{0:X2} in settings.yaml" -f $b)
            }
          }
          Write-Host "OK: settings.yaml control-char check passed"

      - name: Run pipeline (best-effort)
        id: run_pipeline
        continue-on-error: true
        shell: powershell
        run: |
          $argsList = @()

          # Default: if use_sample_data=true and no explicit start_from => start at silver
          $startFrom = "${{ inputs.start_from }}"
          if ("${{ inputs.use_sample_data }}" -eq "true" -and -not $startFrom) {
            $startFrom = "silver"
          }
          if ($startFrom) {
            $argsList += "--start-from"
            $argsList += $startFrom
          }

          if ("${{ inputs.layer }}") {
            $argsList += "--layer"
            $argsList += "${{ inputs.layer }}"
          }

          if ("${{ inputs.step }}") {
            $argsList += "--step"
            $argsList += "${{ inputs.step }}"
          }

          if ("${{ inputs.force }}" -eq "true") {
            $argsList += "--force"
          }

          Write-Host "Running python -u -m src.ops.runner $argsList"
          python -u -m src.ops.runner @argsList

      - name: Mark run status
        shell: powershell
        run: |
          if ("${{ steps.run_pipeline.outcome }}" -eq "success") {
            "SUCCESS" | Out-File -Encoding ascii -FilePath (Join-Path $env:CI_ARTIFACTS_DIR "pipeline_status.txt")
          } else {
            "FAILED_OR_PARTIAL" | Out-File -Encoding ascii -FilePath (Join-Path $env:CI_ARTIFACTS_DIR "pipeline_status.txt")
          }
          Get-Content (Join-Path $env:CI_ARTIFACTS_DIR "pipeline_status.txt")

      - name: Collect run_logs (src/run_logs)
        shell: powershell
        run: |
          $dest = Join-Path $env:CI_ARTIFACTS_DIR "run_logs_src"
          if (Test-Path $env:CI_RUN_LOGS_DIR) {
            Copy-Item -Recurse -Force $env:CI_RUN_LOGS_DIR $dest
          } else {
            "No run_logs dir found." | Out-File -Encoding utf8 -FilePath (Join-Path $env:CI_ARTIFACTS_DIR "run_logs_missing.txt")
          }

      - name: Collect key outputs (eval/audit/gold)
        shell: powershell
        run: |
          $subset = Join-Path $env:CI_ARTIFACTS_DIR "data_subset"
          New-Item -ItemType Directory -Force -Path $subset | Out-Null

          if (Test-Path "data/eval/ml2") {
            New-Item -ItemType Directory -Force -Path (Join-Path $subset "eval") | Out-Null
            Copy-Item -Recurse -Force "data/eval/ml2" (Join-Path $subset "eval")
          }

          if (Test-Path "data/audit") {
            Copy-Item -Recurse -Force "data/audit" $subset
          }

          if (Test-Path "data/gold") {
            Copy-Item -Recurse -Force "data/gold" $subset
          }

      - name: Debug repo files (verify scripts)
        shell: powershell
        run: |
          Write-Host "PWD:" (Get-Location)
          Write-Host "Listing scripts folder:"
          if (Test-Path "scripts") { dir scripts } else { Write-Host "scripts/ not found" }
          Write-Host "Listing repo root:"
          dir

      - name: Create snapshot manifest
        shell: powershell
        run: |
          python scripts/ci_snapshot_manifest.py

      - name: Upload CI artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: planning-engine-step1-artifacts
          path: ci_artifacts
          if-no-files-found: warn
          retention-days: 14