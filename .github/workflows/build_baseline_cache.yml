name: Build Baseline Data Cache (Seed from local snapshot)

on:
  workflow_dispatch:
    inputs:
      baseline_key:
        description: "Cache key suffix. Change this to refresh baseline (e.g., v1 -> v2)."
        required: false
        default: "v1"
      include_silver:
        description: "Also seed silver (true/false)"
        required: false
        default: "true"

permissions:
  contents: read

concurrency:
  group: build-baseline-cache-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  OPS_CI: "0"

jobs:
  build-baseline:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Prepare folders
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path data | Out-Null
          New-Item -ItemType Directory -Force -Path src/run_logs | Out-Null

      # OPTIONAL: restore existing baseline cache first (if present)
      - name: Restore baseline cache (optional)
        uses: actions/cache@v4
        with:
          path: |
            data/bronze
            data/silver
          key: baseline-data-${{ runner.os }}-${{ inputs.baseline_key }}

      - name: Seed Bronze from local snapshot (data_backup)
        shell: powershell
        run: |
          $src = "data_backup\bronze"
          $dst = "data\bronze"

          if (Test-Path $dst) {
            Write-Host "data/bronze already exists; skipping seed."
            exit 0
          }

          if (!(Test-Path $src)) {
            throw "Seed source not found: $src. Ensure baseline parquet snapshot exists on runner."
          }

          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          Write-Host "Seeding bronze snapshot: $src -> $dst"

          # robocopy returns codes 0-7 as success. 8+ is failure.
          robocopy $src $dst /E /COPY:DAT /R:2 /W:2
          if ($LASTEXITCODE -ge 8) { throw "Robocopy bronze failed with code $LASTEXITCODE" }

      - name: Seed Silver from local snapshot (data_backup)
        if: ${{ inputs.include_silver == 'true' }}
        shell: powershell
        run: |
          $src = "data_backup\silver"
          $dst = "data\silver"

          if (Test-Path $dst) {
            Write-Host "data/silver already exists; skipping seed."
            exit 0
          }

          if (!(Test-Path $src)) {
            throw "Seed source not found: $src. Ensure baseline parquet snapshot exists on runner."
          }

          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          Write-Host "Seeding silver snapshot: $src -> $dst"

          robocopy $src $dst /E /COPY:DAT /R:2 /W:2
          if ($LASTEXITCODE -ge 8) { throw "Robocopy silver failed with code $LASTEXITCODE" }

      - name: Verify baseline outputs exist
        shell: powershell
        run: |
          if (!(Test-Path "data/bronze")) { throw "Missing data/bronze after seeding" }
          $b = Get-ChildItem -Recurse data/bronze -ErrorAction SilentlyContinue
          if ($b.Count -eq 0) { throw "data/bronze is empty after seeding" }

          if ("${{ inputs.include_silver }}" -eq "true") {
            if (!(Test-Path "data/silver")) { throw "Missing data/silver after seeding" }
            $s = Get-ChildItem -Recurse data/silver -ErrorAction SilentlyContinue
            if ($s.Count -eq 0) { throw "data/silver is empty after seeding" }
          }

          Write-Host "Baseline OK. bronze files:" $b.Count
          if (Test-Path data/silver) { Write-Host "silver files:" (Get-ChildItem -Recurse data/silver).Count }

      - name: Save baseline cache
        uses: actions/cache@v4
        with:
          path: |
            data/bronze
            data/silver
          key: baseline-data-${{ runner.os }}-${{ inputs.baseline_key }}