name: Build Baseline Data Cache (Seed from local snapshot)

on:
  workflow_dispatch:
    inputs:
      baseline_key:
        description: "Cache key suffix. Change this to refresh baseline (e.g., v1 -> v2)."
        required: false
        default: "v1"
      include_silver:
        description: "Also seed silver (true/false)"
        required: false
        default: "true"

permissions:
  contents: read

concurrency:
  group: build-baseline-cache-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  OPS_CI: "0"

jobs:
  build-baseline:
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Prepare folders
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path data | Out-Null
          New-Item -ItemType Directory -Force -Path src/run_logs | Out-Null

      # OPTIONAL: restore existing baseline cache first (if present)
      - name: Restore baseline cache (optional)
        uses: actions/cache@v4
        with:
          path: |
            data/bronze
            data/silver
          key: baseline-data-${{ runner.os }}-${{ inputs.baseline_key }}

      - name: Seed Bronze from local snapshot (no DB)
        shell: powershell
        run: |
          $src = "C:\Users\paul.loja\PYPROYECTOS\Data-LakeHouse\Data-LakeHouse\data_backup\bronze"
          $dst = "data\bronze"

          Write-Host "Seeding Bronze..."
          Write-Host "SRC = $src"
          Write-Host "DST = $dst"

          if (!(Test-Path $src)) {
            throw "Seed source not found: $src. This path must exist on the RUNNER machine and be accessible to the runner user."
          }

          # IMPORTANT: reset destination to avoid mixing old cache contents
          if (Test-Path $dst) {
            Write-Host "Cleaning existing DST folder to avoid stale/mixed baseline..."
            Remove-Item -Recurse -Force $dst
          }
          New-Item -ItemType Directory -Force -Path $dst | Out-Null

          robocopy $src $dst /E /COPY:DAT /R:2 /W:2
          $rc = $LASTEXITCODE

          # robocopy codes: 0-7 = OK, 8+ = FAIL
          if ($rc -ge 8) { throw "Robocopy failed: $rc" }

          Write-Host "Robocopy OK (code=$rc). Normalizing to exit 0 for GitHub Actions."
          $global:LASTEXITCODE = 0

      - name: Seed Silver from local snapshot (data_backup)
        if: ${{ inputs.include_silver == 'true' }}
        shell: powershell
        run: |
          $src = "C:\Users\paul.loja\PYPROYECTOS\Data-LakeHouse\Data-LakeHouse\data_backup\silver"
          $dst = "data\silver"

          Write-Host "Seeding Silver..."
          Write-Host "SRC = $src"
          Write-Host "DST = $dst"

          if (!(Test-Path $src)) {
            throw "Seed source not found: $src"
          }

          if (Test-Path $dst) {
            Write-Host "Cleaning existing DST silver folder to avoid stale/mixed baseline..."
            Remove-Item -Recurse -Force $dst
          }
          New-Item -ItemType Directory -Force -Path $dst | Out-Null

          robocopy $src $dst /E /COPY:DAT /R:2 /W:2
          $rc = $LASTEXITCODE

          if ($rc -ge 8) { throw "Robocopy silver failed: $rc" }

          Write-Host "Robocopy OK (code=$rc). Normalizing to exit 0 for GitHub Actions."
          $global:LASTEXITCODE = 0

      - name: Verify baseline outputs exist
        shell: powershell
        run: |
          if (!(Test-Path "data/bronze")) { throw "Missing data/bronze after seeding" }
          $b = Get-ChildItem -Recurse data/bronze -ErrorAction SilentlyContinue
          if ($b.Count -eq 0) { throw "data/bronze is empty after seeding" }

          if ("${{ inputs.include_silver }}" -eq "true") {
            if (!(Test-Path "data/silver")) { throw "Missing data/silver after seeding" }
            $s = Get-ChildItem -Recurse data/silver -ErrorAction SilentlyContinue
            if ($s.Count -eq 0) { throw "data/silver is empty after seeding" }
          }

          Write-Host "Baseline OK. bronze files:" $b.Count
          if (Test-Path data/silver) { Write-Host "silver files:" (Get-ChildItem -Recurse data/silver).Count }

      - name: Guardrail - require ventas raw in bronze
        shell: powershell
        run: |
          $v2025 = "data\bronze\ventas_2025_raw.parquet"
          $v2026 = "data\bronze\ventas_2026_raw.parquet"

          Write-Host "Checking ventas raw presence..."
          Write-Host "Expect: $v2025"
          Write-Host "Expect: $v2026"

          if (!(Test-Path $v2025)) {
            Write-Host "Listing data\bronze for debugging:"
            dir data\bronze
            throw "Missing ventas_2025_raw.parquet in data/bronze after seeding"
          }

          if (!(Test-Path $v2026)) {
            Write-Host "Listing data\bronze for debugging:"
            dir data\bronze
            throw "Missing ventas_2026_raw.parquet in data/bronze after seeding"
          }

          Write-Host "OK: ventas raw files are present"

      - name: Save baseline cache
        uses: actions/cache@v4
        with:
          path: |
            data/bronze
            data/silver
          key: baseline-data-${{ runner.os }}-${{ inputs.baseline_key }}